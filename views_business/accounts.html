<!DOCTYPE html>
<html lang="en">
<head>
    <title>智慧社区商家管理修改账户信息</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="智慧社区商家管理修改账户信息">
    <meta name="keyword" content="智慧社区商家管理修改账户信息">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/simple-line-icons.css" rel="stylesheet">
    <link href="css/glyphicons.css" rel="stylesheet">
    <link href="css/glyphicons-filetypes.css" rel="stylesheet">
    <link href="css/glyphicons-social.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/total_zsh.css" rel="stylesheet">
    <link href="css/total_ymm.css" rel="stylesheet">
    <script src="js/libs/jquery.min.js"></script>
    <script src="js/libs/bootstrap.min.js"></script>
    <script src="js/views/total_zsh.js"></script>
    <script src="js/views/total_ymm.js"></script>
    <script type="text/javascript" src="./node_modules/angular/angular.min.js"></script>
    <script src="http://cdn.bootcss.com/angular-ui-bootstrap/0.11.2/ui-bootstrap-tpls.js"></script>
    <script type="text/javascript" src="./js/views/totalAngular.js"></script>
    <script src="js/views/jquery.uploadView.js"></script>
</head>
<body class="app header-fixed sidebar-fixed aside-menu-fixed aside-menu-hidden" ng-app="project_business" ng-controller="businessAccount" ng-cloak>
    <!-- 引入公共header部分 -->
    <div ng-include="'header.html'"></div>
    <div class="app-body">
        <!-- 引入公共sideBar区域开始 -->
        <div ng-include="'sideBar.html'"></div>
        <!-- 主要内容区 -->
        <main class="main">
            <div class="container-fluid" style="margin-top:30px;">
                <div class="animated">
                    <div class="row">
                        <div class="col-md-12">
                            <ul class="nav nav-tabs" role="tablist" style="background: #DAE1E8;">
                                <li class="nav-item">
                                    <a class="nav-link active" data-toggle="tab" href="#home" role="tab" aria-controls="home">
                                        账户资料
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-toggle="tab" href="#profile" role="tab" aria-controls="profile">
                                        修改密码
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-toggle="tab" href="#messages" role="tab" aria-controls="messages">
                                        修改手机号
                                    </a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane active" id="home" role="tabpanel">
                                    <form class="bs-example bs-example-form" role="form">
                                        <div class="input-group">
                                            <label for="" class="col-md-2 pull-left">
                                                头像
                                            </label>
                                            <div class="js_uploadBox account_uploadBox">
                                                <div class="js_showBox account_showBox">
                                                    <img class="js_logoBox file_img" src="{{LoginImg}}" style="width:60px;height:60px;">
                                                </div>
                                                <div class="btn-upload" style="margin-top:5px;">
                                                  <input class="js_upFile account_upfile" type="file" name="cover">
                                                </div>
                                            </div>
                                        </div>
                                        <br/>
                                        <div class="input-group">
                                            <label for="" class="col-md-2 pull-left">用户名
                                            </label>
                                            <input type="text" class="form-control col-md-4" value="{{LoginName}}"  required minlength="2" maxlength="8" ng-model="LoginName">
                                        </div>
                                        <br/>
                                        <!-- <div class="input-group">
                                            <label for="" class="col-md-2 pull-left">常用邮箱
                                            </label>
                                            <input type="email" class="form-control col-md-4" value="{{LoginEmail}}" ng-model="LoginEmail" required>
                                        </div>
                                        <br/> -->
                                        <div class="input-group">
                                            <label for="" class="col-md-2"></label>
                                            <button type="button" class="btn btn-primary" ng-click="editBase()">
                                                保存
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="tab-pane" id="profile" role="tabpanel">
                                    <form class="bs-example bs-example-form" role="form">
                                        <div class="input-group">
                                            <label for="" class="col-md-2 pull-left">
                                                原密码
                                            </label>
                                            <input type="password" class="form-control col-md-4" value="" ng-model="oldPass" required minlength="6" maxlength="18">
                                        </div>
                                        <br/>
                                        <div class="input-group">
                                            <label for="" class="col-md-2 pull-left">
                                                新密码
                                            </label>
                                            <input type="password" class="form-control col-md-4" value="" ng-model="newpas" required minlength="6" maxlength="18">
                                        </div>
                                        <br/>
                                        <div class="input-group">
                                            <label for="" class="col-md-2 pull-left">
                                                确认新密码
                                            </label>
                                            <input type="password" class="form-control col-md-4" value="" ng-model="newPass" required minlength="6" maxlength="18">
                                        </div>
                                        <br/>
                                        <div class="input-group">
                                            <label for="" class="col-md-2"></label>
                                            <button type="button" class="btn btn-primary" ng-click="editAccountPass()">
                                                修改
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div class="tab-pane" id="messages" role="tabpanel">
                                    <form class="bs-example bs-example-form" role="form">
                                        <div class="input-group">
                                            <label for="" class="col-md-2 pull-left">
                                                手机号
                                            </label>
                                            <input type="text" class="form-control col-md-4 inputPhone"  placeholder="请输入11位手机号码" required minlength="11" maxlength="11"  ng-model="phone">
                                        </div>
                                        <br/>
                                        <div class="input-group account_zsh_phone">
                                            <label for="" class="col-md-2 pull-left">
                                                验证码
                                            </label>
                                            <input type="text" class="form-control col-md-2 messageYzm" value="" placeholder="输入验证码" style="margin-right:5px;" ng-model="messageYZM">
                                            <input type="button" class="btn btn-primary" value="免费获取验证码"  onClick="settime(this)"/>
                                        </div>
                                        <br/>
                                        <div class="input-group">
                                            <label for="" class="col-md-2"></label>
                                            <button type="button" class="btn btn-primary" ng-click="editPhone()">
                                                修改
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <!--/.row-->
                    </div>
                </div>
                <!-- /.conainer-fluid -->
            </div>
        </main>
    </div>
</body>

</html>
<script type="text/javascript">
    httpBaseUrl="http://Dev.jgsoft.org";
    var loginKey=JSON.parse(window.sessionStorage.getItem("userData"));
    var app=angular.module("project_business",[]);
    /*修改账户信息开始*/
    if(loginKey==null){
        alert("请先登录！");
        window.location.href="../views_zong/index.html";
    }else{
    app.controller("businessAccount",function($scope,$http,$timeout,$interval,$location){
    // 取得用户登录的帐号相关信息
    $scope.userLoginUserData=JSON.parse(window.sessionStorage.getItem("userData"));
    $scope.userLoginID=$scope.userLoginUserData.loginId;
    $scope.LoginImg=JSON.parse(window.sessionStorage.getItem("userData")).img;
    $scope.LoginName=JSON.parse(window.sessionStorage.getItem("userData")).loginName;
    $scope.LoginEmail=JSON.parse(window.sessionStorage.getItem("userData")).email;
    // 修改账户资料
    $(".js_upFile.account_upfile").uploadView({
        uploadBox: '.js_uploadBox.account_uploadBox', //设置上传框容器
        showBox: '.js_showBox.account_showBox', //设置显示预览图片的容器
        width: 60, //预览图片的宽度，单位px
        height: 60, //预览图片的高度，单位px
        allowType: ["gif", "jpeg", "jpg", "bmp", "png"], //允许上传图片的类型
        maxSize: 2, //允许上传图片的最大尺寸，单位M
        success: function(e) {
            // $(".js_uploadText").text('更改');
            alert('图片上传成功');
        }
    });
    $scope.editBase=function(){
         $scope.activeImgUrl=$(".js_showBox.account_showBox img").attr("src");
        var editBaseData={
          "loginId":$scope.userLoginID,
          "loginName":$scope.LoginName,
          "img":$scope.activeImgUrl,
          // "email":$scope.LoginEmail
          "email":""
        };
        if($scope.LoginName==undefined){
            alert("请输入最少2个最多8个字符的用户名！");
        }/*else if($scope.LoginEmail==undefined){
            alert("请输入正确的邮箱地址！");
        }*/else{
            $http.post(httpBaseUrl+"/api/streetadmin/ModifyLoginInfo",editBaseData).then(function(response){
            if(response.data.code !== 200){
                alert(response.data.msg);
            }else if(response.data.code == 200){
                alert("恭喜你、账户资料修改成功,请重新登录！");
                console.log(editBaseData);
                window.location.href="../views_zong/index.html";
            }
        }); 
        }
    };
    // 修改密码
    $scope.editAccountPass=function(){
        var editPass={
          "loginId":$scope.userLoginID,
          "oldPassword":$scope.oldPass,
          "newPassword":$scope.newPass
        };
        if($scope.oldPass==undefined){
            alert("请输入至少6位数的原密码！");
        }else if($scope.newpas==undefined){
            alert("请输入至少6位数的新密码！");
        }else if($scope.newPass==undefined){
            alert("请输入至少6位数的确认密码！");
        }else if($scope.newpas !== $scope.newPass){
            alert("2次密码不一致、请重新输入！");
        }else{
             $http.post(httpBaseUrl+"/api/streetadmin/ModifyLoginPassWord",editPass).then(function(response){
                    if(response.data.code !== 200){
                        alert(response.data.msg);
                    }else if(response.data.code ==200){
                        alert("恭喜你、密码修改成功,请重新登录！");
                        window.location.href="../views_zong/index.html";
                    }
                });
        }
    };
    //修改手机号
    $scope.editPhone=function(){
        var editPhoneData={
          "loginId":$scope.userLoginID,
          "mobile":$scope.phone,
          "vcode":$scope.messageYZM
        };
            $http.post(httpBaseUrl+"/api/streetadmin/ModifyLoginMobile",editPhoneData).then(function(response){
                if(response.data.code !== 200){
                    alert(response.data.msg);
                }else if(response.data.code == 200){
                    alert("恭喜你、手机号码修改成功,请重新登录！");
                    window.location.href="../views_zong/index.html";
                }
            });
        };

    });
    /*修改手机号短信60秒发送*/
    var countdown=60; 
    function settime(obj) {
        var correctPhone = /^1[3|5|7|8][0-9]{9}/,
            phone=$(".inputPhone").val(),
            sf=phone.match(correctPhone);
        if(phone == ""){
            alert("请输入11位手机号码！");
        }else if(sf == null){
            alert("请输入11位正确手机号码！");
        }else{
            if (countdown == 0) {
            obj.removeAttribute("disabled");    
            obj.value="免费获取验证码"; 
            countdown = 60;
            return;
            } else {
                obj.setAttribute("disabled", true);
                obj.value="重新发送(" + countdown + ")"; 
                countdown--;
                if(countdown>=59){
                    $.ajax({
                    type:"GET",
                    url:httpBaseUrl+"/api/Mailbox/SendSMSVCode?mobile="+phone+"&key=register",
                    success:function(response){
                        console.log(response);
                        if(response.code !== 200){
                            alert(response.msg);
                        }else if(response.code == 200){
                            alert("恭喜你、短信验证码已发送、请注意查收！");
                        }
                    },
                    error:function(){
                        alert("对不起、当前网络较慢、请稍后请求！");
                    }
                });
                }
            };
            setTimeout(function() { 
                settime(obj) }
                ,1000); 
        }
    };
};
/*修改账户信息结束*/
</script>